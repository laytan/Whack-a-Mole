<!DOCTYPE html>
<html lang="nl">
<head>
    <title>Whack-A-Mole</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <div id="options">
		<input type="radio" name="mode" value="easy" checked>
		<input type="radio" name="mode" value="normal">
		<input type="radio" name="mode" value="hard">
		<input type="radio" name="mode" value="insane">
		&nbsp;
        <button id="submit" class="btn btn-default" onclick="Validate()">Begin!</button>
		<p>
		<h1>Highscore</h1>
		<span id="scores"></span>
		</p>
    </div>

    <div id="board"></div>
	<div id="ui">
		<button id="stop" class="btn btn-lg" onclick="StopGame()">Stop</button>
		<p id="score" class="uiText">0</p>
		<p id="tijd" class="uiText">20</p>
	</div>

    <script>
		//Amount of clicks on moles
		var score = 0;

		//Populated by generateboard with the board
        var places = [];

		//Interval to update time every second
		var timeInterval;
		//Interval that spawns moles
		var gameLoop;

		//Is the game in progress or on UI screen
		var inProgress = false;

		//Set at the beginning to the time var, used to record highscore
		var maxtime;

		//Changeable for different feel
		var time = 40;

		//Changed in ui, possibilities: easy, normal, hard, insane
		var difficulty;
		//Changed according to difficulty settings
		var grootte;
		var fadeTime;
		var stayDuration;
		var moleInterval;

		if(localStorage.getItem('score') != null && localStorage.getItem('tijd') != null && localStorage.getItem('grootte') != null) 
		{
			var highscore = localStorage.getItem('score');
			var tijd = localStorage.getItem('tijd');
			var grootte = localStorage.getItem('grootte');
			document.getElementById("scores").innerHTML = 'Score: ' + highscore + '<br>Tijd: ' + tijd + '<br>Grootte: ' + grootte;
		}

        function Start()
        {
			InitSettings();
			DisplayUI();
            GenerateBoard();
            HideAll();
            Loop();

			inProgress = true;
        }

		function InitSettings()
		{
			switch(document.querySelector('input[name="mode"]:checked').value) 
			{
				case "easy":
					difficulty = "easy";
					grootte = 3;
					fadeTime = 1000;
					stayDuration = 3000;
					moleInterval = 3000;
				break;
				case "normal":
					difficulty = "normal";
					grootte = 4;
					fadeTime = 500;
					stayDuration = 2000;
					moleInterval = 2000;
				break;
				case "hard":
					difficulty = "hard";
					grootte = 5;
					fadeTime = 300;
					stayDuration = 1000;
					moleInterval = 1500;
				break;
				case "insane":
					difficulty = "insane";
					grootte = 5;
					fadeTime = 100;
					stayDuration = 500;
					moleInterval = 1000;
				break;
			}
		}

		function DisplayUI() 
		{
			//Prep maxtime variable for highscores before we change the time variable
			maxtime = time;

			//Display the UI
			document.getElementById("ui").style.display = 'block';

			//Run UpdateTime every second / 1000Milliseconds
			timeInterval = setInterval(function() {UpdateTime()}, 1000);
		}

		function UpdateTime() {
			//Subtracts a second from the time variable and updates it to the UI, if the time is 0 call the function Finished();
			time--;
			if(time < 0) {
				Finished();
			}
			else {
				document.getElementById("tijd").innerHTML = time.toString();
			}
		}

		function Finished() {
			clearInterval(timeInterval);
			//TODO: Stop the game from spawning new moles @ Gameloop function
		}

        function GenerateBoard()
        {
			//Element where the board will go
            var board = document.getElementById('board');

			//Hide the options element
            document.getElementById('options').style.display = 'none';
			
            for (var i = 0; i < grootte; i++)
            {
				//i = 0 increments every time
                for (var j = 0; j < grootte; j++)
                {
					//j = 0 increments every time

					//Like: 00, 01, 02, 03, 10, 11, 12, 13
                    var coord = i.toString() + j.toString();
					//Make a div with a mole's image and the id of the current coord
                    board.innerHTML += '<div id="' + coord + '" class="place"><img id="Img_' + coord + '" class="molImg" onclick="MoleClick(this)" src="Mol.png"></div>';
					//Put the id / coord in the array so we can acces the moles
                    places.push(coord);
                }
				//Break every time we reach the end of the x axis, so the program begins on a new line
                board.innerHTML += '<br>';
            }
			//Scale the moles so they fit a full screen view
			//TODO: plain javascript, get rid of JQuery
            $('.place').css('width', (100 / grootte).toString() + '%');
            $('.place').css('height', (100 / grootte).toString() + 'vh');
        }

        function HideAll()
        {
			//Loop through all moles and call the Hide function on them
            for (var i = 0; i < places.length; i++) {
                Hide(places[i]);
            }
        }

        function Hide(divID)
        {
			//TODO: plain Javascript, get rid of JQuery
			//Fades out the div containing the mole
            $('#' + divID).fadeTo(fadeTime, 0);
        }

        function Show(divID, duration)
        {
			//TODO: plain javascript, get rid of JQuery
			//Fades in the div containing a mole at the coord divID and calls waitAndHide() after that
            $('#' + divID).fadeTo(fadeTime, 1, waitAndHide());

            function waitAndHide()
            {
				//Runs the Hide function on the div with the mole after a duration
                setTimeout(
                    function() {
                        Hide(divID);
                    }
                , duration);
            }
        }

        function MoleClick(event)
        {
			var id = event.id;
			var parent = id.split('_')[1];
			var opacity = window.getComputedStyle(document.getElementById(parent), null).opacity;

			if(opacity > 0) {
				Hit();
			}
        }

        function Hit()
        {
            score++;
			document.getElementById("score").innerHTML = score.toString();

        }

        function Loop()
        {
            setTimeout(GameLoop, moleInterval);
        }

		function GameLoop()
		{
			var randomPlace = places[Math.floor(Math.random() * places.length)];
	        Show(randomPlace, stayDuration);
			Loop();
		}

		function StopGame() 
		{
			if(localStorage.getItem('score') != null && localStorage.getItem('tijd') != null && localStorage.getItem('grootte') != null) 
			{
				var highscore = localStorage.getItem('score');
				if(score > highscore) 
				{
					localStorage.setItem('score', score);
					localStorage.setItem('tijd', maxtime);
					localStorage.setItem('grootte', grootte);
				}
			}
			else 
			{
				localStorage.setItem('score', score);
				localStorage.setItem('tijd', maxtime);
				localStorage.setItem('grootte', grootte);
			}
			inProgress = false;
			location.reload();
		}

		function Validate()
		{
			Start();
		}
    </script>
</body>
</html>